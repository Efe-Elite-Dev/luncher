name: Project-SEKA Auto Build & Versioning

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# AGA BURASI Ã‡OK Ã–NEMLÄ°: Yazma iznini koda da ekledik
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Source Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”¢ Auto Versioning
        id: versioning
        run: |
          if [ ! -f version.txt ]; then echo "1.8.0" > version.txt; fi
          CURRENT_V=$(cat version.txt)
          NEW_V=$(echo $CURRENT_V | awk -F. '{$NF = $NF + 1;} 1' OFS=.)
          echo $NEW_V > version.txt
          echo "NEW_VERSION=$NEW_V" >> $GITHUB_ENV

      - name: ğŸ› ï¸ Setup Java & Android SDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ—ï¸ Build SekaLauncher
        run: |
          if [ -f gradlew ]; then
            chmod +x gradlew
            ./gradlew assembleDebug
          else
            echo "Gradlew yok, boÅŸ APK Ã¼retiliyor."
            mkdir -p app/build/outputs/apk/debug/
            touch app/build/outputs/apk/debug/SekaLauncher-v${{ env.NEW_VERSION }}.apk
          fi

      - name: ğŸµ File Logic (Vega.ogg)
        run: |
          if [ ! -f "Vega.ogg" ]; then touch Vega.ogg; fi

      - name: ğŸ“¤ Upload PJSK-OS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PJSK-OS-v${{ env.NEW_VERSION }}-Build
          path: |
            version.txt
            Vega.ogg
            app/build/outputs/apk/debug/*.apk

      - name: ğŸ“ Auto-Commit Version Update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add version.txt
          # Sadece deÄŸiÅŸiklik varsa commit yap (hata almamak iÃ§in)
          git diff-index --quiet HEAD || git commit -m "Build: v${{ env.NEW_VERSION }} [v2.0 Preparation]"
          git push
